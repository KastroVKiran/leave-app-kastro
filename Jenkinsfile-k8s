stage('Verify Deployment') {
    steps {
        script {
            def appUrl = sh(returnStdout: true, script: """
                kubectl get svc leave-management-service -n ${K8S_NAMESPACE} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
            """).trim()
            echo "##[success] Application deployed: http://${appUrl}:8090"
        }
    }
}

post {
    always {
        sh 'docker system prune -f'
    }
    failure {
        sh """
            kubectl get pods -n ${K8S_NAMESPACE} > k8s-logs/failure.log
            kubectl logs -l app=mysql -n ${K8S_NAMESPACE} --tail=50 >> k8s-logs/failure.log
        """
    }
}
